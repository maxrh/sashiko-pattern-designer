---
import Layout from '../layouts/Layout.astro';
import PatternDesigner from '../components/PatternDesigner.jsx';
import ErrorBoundary from '../components/ErrorBoundary.jsx';
---

<Layout title="Sashiko Pattern Designer">
	<ErrorBoundary client:only="react">
		<PatternDesigner client:only="react" />
	</ErrorBoundary>
	
	<!-- PWA Service Worker Registration -->
	<script is:inline>
		if ('serviceWorker' in navigator) {
			window.addEventListener('load', async () => {
				try {
					const registration = await navigator.serviceWorker.register('/sw.js', { 
						scope: '/',
						updateViaCache: 'none'
					});
					
					console.log('SW registered:', registration);
					
					// Check for updates every time page loads
					registration.update();
					
					// Store/check version for update notification
					const checkVersion = async () => {
						try {
							const response = await fetch('/version.json?' + Date.now(), {
								cache: 'no-store'
							});
							
							if (response.ok) {
								const remoteVersion = await response.json();
								const stored = localStorage.getItem('app_version');
								const localVersion = stored ? JSON.parse(stored) : null;
								
								if (!localVersion) {
									// First visit - just store version
									localStorage.setItem('app_version', JSON.stringify(remoteVersion));
									console.log('Version stored:', remoteVersion);
								} else if (localVersion.timestamp !== remoteVersion.timestamp) {
									// New version detected
									console.log('New version available:', remoteVersion);
									console.log('Current version:', localVersion);
									localStorage.setItem('app_version', JSON.stringify(remoteVersion));
									
									// The service worker will handle the update automatically
									// Just refresh the page to get new content
									setTimeout(() => {
										console.log('Applying update...');
										window.location.reload();
									}, 1000);
								} else {
									console.log('Version unchanged');
								}
							}
						} catch (error) {
							console.log('Version check failed:', error.message);
						}
					};
					
					// Check version 3 seconds after load
					setTimeout(checkVersion, 3000);
					
				} catch (error) {
					console.log('SW registration failed:', error);
				}
			});
		}
	</script>
</Layout>
