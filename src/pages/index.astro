---
import Layout from '../layouts/Layout.astro';
import PatternDesigner from '../components/PatternDesigner.jsx';
import ErrorBoundary from '../components/ErrorBoundary.jsx';
---

<Layout title="Sashiko Pattern Designer">
	<ErrorBoundary client:only="react">
		<PatternDesigner client:only="react" />
	</ErrorBoundary>
	
	<!-- PWA Service Worker Registration -->
	<script is:inline>
		if ('serviceWorker' in navigator) {
			window.addEventListener('load', async () => {
				try {
					const registration = await navigator.serviceWorker.register('/sw.js', { 
						scope: '/',
						updateViaCache: 'none'
					});
					
					console.log('SW registered:', registration);
					
					// Store version for display in UI
					const storeVersion = async () => {
						try {
							const response = await fetch('/version.json');
							if (response.ok) {
								const versionData = await response.json();
								localStorage.setItem('app_version', JSON.stringify(versionData));
								console.log('Version:', versionData.version);
								
								// Trigger custom event so React component can update
								window.dispatchEvent(new CustomEvent('versionUpdated', { 
									detail: versionData 
								}));
							}
						} catch (error) {
							console.log('Could not load version:', error.message);
						}
					};
					
					// Store version for UI display
					setTimeout(storeVersion, 1000);
					
					// Manual cache clear shortcut (Ctrl+Shift+U)
					window.addEventListener('keydown', async (e) => {
						if (e.ctrlKey && e.shiftKey && e.key === 'U') {
							e.preventDefault();
							console.log('üîÑ Manual cache clear triggered...');
							
							try {
								// Unregister all service workers
								const registrations = await navigator.serviceWorker.getRegistrations();
								for (let reg of registrations) {
									await reg.unregister();
									console.log('‚úÖ Service worker unregistered');
								}
								
								// Clear all cache storage (preserves localStorage/IndexedDB)
								if ('caches' in window) {
									const cacheNames = await caches.keys();
									await Promise.all(cacheNames.map(name => caches.delete(name)));
									console.log('‚úÖ All caches cleared:', cacheNames);
								}
								
								// Hard reload to get fresh content
								console.log('üîÑ Reloading with fresh content...');
								window.location.reload(true);
							} catch (error) {
								console.error('‚ùå Cache clear failed:', error);
								alert('Failed to clear cache. Check console for details.');
							}
						}
					});
					
				} catch (error) {
					console.log('SW registration failed:', error);
				}
			});
		}
	</script>
</Layout>
